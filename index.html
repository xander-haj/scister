<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OCR Image Processor with Clickable Text Highlights</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tesseract.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 15px;
        }
        p {
            margin-bottom: 15px;
        }
        .input-section {
            margin-bottom: 20px;
        }
        .input-section label {
            display: block;
            margin: 10px 0 5px 0;
        }
        #imageInput {
            margin-bottom: 10px;
        }
        #imageContainer {
            position: relative;
            display: inline-block;
            margin-top: 10px;
            padding: 0;
        }
        #uploadedImage {
            max-width: 100%;
            border: 1px solid #ddd;
            display: block;
        }
        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            pointer-events: auto;
        }
        #statusMessage {
            font-size: 14px;
            color: #555;
            margin-top: 10px;
        }
        #fieldContainer {
            margin-top: 20px;
        }
        #fieldContainer label {
            font-weight: bold;
            margin: 10px 0 5px 0;
        }
        #fieldContainer input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
        }
        .buttons-container button {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            margin-right: 10px;
        }
        #perform-ocr {
            background-color: #2cb67d;
            color: #fff;
        }
        #update-table {
            background-color: #3498db;
            color: #fff;
        }
        #save-csv {
            background-color: #f39c12;
            color: #fff;
        }
        #clear-image {
            background-color: #d00000;
            color: #fff;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }
        th {
            background: #f2f2f2;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>OCR Image Processor with Clickable Text Highlights</h1>
    <p>Upload an image and perform OCR. Recognized words will be highlighted in light blue on the image. Click on a highlighted word to assign it to one of the input fields (Item Name Short, Item Name Long, UPC, Location, Downstack, Notes). You can edit fields manually as well. Once done, press "Update Table" to add a row to the table. Process multiple images by clearing the image and fields. Finally, press "Save CSV" to download all collected data.</p>

    <div class="input-section">
        <label for="imageInput">Upload Image:</label>
        <input type="file" id="imageInput" accept="image/*">
        <div id="imageContainer" style="display:none;">
            <img id="uploadedImage" alt="Uploaded Image">
            <canvas id="overlayCanvas"></canvas>
        </div>
        <p id="statusMessage"></p>
        <button id="perform-ocr">Perform OCR</button>
        <button id="clear-image">Clear Image & Fields</button>
    </div>

    <div id="fieldContainer">
        <label for="field1">Item Name Short:</label>
        <input type="text" id="field1">
        <label for="field2">Item Name Long:</label>
        <input type="text" id="field2">
        <label for="field3">UPC:</label>
        <input type="text" id="field3">
        <label for="field4">Location:</label>
        <input type="text" id="field4">
        <label for="field5">Downstack:</label>
        <input type="text" id="field5">
        <label for="field6">Notes:</label>
        <input type="text" id="field6">
    </div>

    <div class="buttons-container">
        <button id="update-table">Update Table</button>
        <button id="save-csv">Save CSV</button>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
                <th>Item Name Short</th>
                <th>Item Name Long</th>
                <th>UPC</th>
                <th>Location</th>
                <th>Downstack</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be appended here -->
        </tbody>
    </table>

    <script>
        const imageInput = document.getElementById('imageInput');
        const uploadedImage = document.getElementById('uploadedImage');
        const imageContainer = document.getElementById('imageContainer');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const performOcrButton = document.getElementById('perform-ocr');
        const clearImageButton = document.getElementById('clear-image');
        const statusMessage = document.getElementById('statusMessage');
        const dataTable = document.getElementById('dataTable').querySelector('tbody');

        const field1 = document.getElementById('field1');
        const field2 = document.getElementById('field2');
        const field3 = document.getElementById('field3');
        const field4 = document.getElementById('field4');
        const field5 = document.getElementById('field5');
        const field6 = document.getElementById('field6');

        const updateTableButton = document.getElementById('update-table');
        const saveCsvButton = document.getElementById('save-csv');

        let currentWords = []; // Store recognized words with their bounding boxes
        let imageDataURL = null; // For OCR

        imageInput.addEventListener('change', () => {
            const file = imageInput.files[0];
            if (!file) {
                resetImageDisplay();
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage.src = e.target.result;
                uploadedImage.onload = () => {
                    imageContainer.style.display = 'inline-block';
                    overlayCanvas.width = uploadedImage.naturalWidth;
                    overlayCanvas.height = uploadedImage.naturalHeight;
                    clearCanvas();
                    statusMessage.textContent = 'Image loaded. Click "Perform OCR" to proceed.';
                    imageDataURL = e.target.result;
                };
            };
            reader.readAsDataURL(file);
        });

        performOcrButton.addEventListener('click', async () => {
            if (!imageDataURL) {
                alert('Please select an image first.');
                return;
            }
            statusMessage.textContent = 'Performing OCR... please wait.';
            clearCanvas();
            currentWords = [];
            const textData = await runOCR(imageDataURL);
            statusMessage.textContent = 'OCR complete. Click on highlighted text to assign fields.';
            drawWords(textData);
        });

        overlayCanvas.addEventListener('click', (e) => {
            const rect = overlayCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            for (let w of currentWords) {
                if (x >= w.x && x <= w.x + w.width && y >= w.y && y <= w.y + w.height) {
                    assignWordToField(w.text);
                    break;
                }
            }
        });

        clearImageButton.addEventListener('click', () => {
            resetImageDisplay();
            resetFields();
            statusMessage.textContent = 'Cleared image and fields. Table is preserved. You can upload a new image.';
        });

        updateTableButton.addEventListener('click', () => {
            const row = document.createElement('tr');
            const cols = [field1.value.trim(), field2.value.trim(), field3.value.trim(), field4.value.trim(), field5.value.trim(), field6.value.trim()];
            if (cols.every(c => c === '')) {
                alert('All fields are empty. Nothing to add.');
                return;
            }
            cols.forEach(c => {
                const td = document.createElement('td');
                td.textContent = c;
                row.appendChild(td);
            });
            dataTable.appendChild(row);
            alert('Row added to the table.');
        });

        saveCsvButton.addEventListener('click', () => {
            const rows = dataTable.querySelectorAll('tr');
            if (rows.length === 0) {
                alert('No data to save.');
                return;
            }
            const headers = ["Item Name Short", "Item Name Long", "UPC", "Location", "Downstack", "Notes"];
            const data = [headers];

            rows.forEach(r => {
                const cells = r.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`);
                data.push(rowData);
            });

            const csvContent = data.map(r => r.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ocr_data.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function resetImageDisplay() {
            uploadedImage.src = '';
            imageContainer.style.display = 'none';
            imageDataURL = null;
            clearCanvas();
        }

        function resetFields() {
            field1.value = '';
            field2.value = '';
            field3.value = '';
            field4.value = '';
            field5.value = '';
            field6.value = '';
        }

        function clearCanvas() {
            const ctx = overlayCanvas.getContext('2d');
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        }

        async function runOCR(dataURL) {
            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            const { data } = await worker.recognize(dataURL);
            await worker.terminate();
            return data;
        }

        function drawWords(data) {
            const ctx = overlayCanvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'rgba(0, 150, 255, 1)';
            ctx.fillStyle = 'rgba(0, 150, 255, 0.25)';
        
            const scaleX = uploadedImage.naturalWidth / data.width;  // Use natural dimensions
            const scaleY = uploadedImage.naturalHeight / data.height;
        
            if (!data.words) return;
        
            for (let word of data.words) {
                const { text, bbox } = word;
                if (!text.trim()) continue;
        
                const x = bbox.x0 * scaleX;
                const y = bbox.y0 * scaleY;
                const w = (bbox.x1 - bbox.x0) * scaleX;
                const h = (bbox.y1 - bbox.y0) * scaleY;
        
                // Draw the highlight box
                ctx.fillRect(x, y, w, h);
                ctx.strokeRect(x, y, w, h);
        
                currentWords.push({
                    text: text.trim(),
                    x: x, y: y, width: w, height: h
                });
            }
        }


        function assignWordToField(wordText) {
            const choice = prompt(
                `Choose a field to assign this text:\n` +
                `1) Item Name Short\n` +
                `2) Item Name Long\n` +
                `3) UPC\n` +
                `4) Location\n` +
                `5) Downstack\n` +
                `6) Notes\n\n` +
                `Enter a number 1-6:`
            );
            if (!choice) return; // user canceled
            const num = parseInt(choice, 10);
            if (isNaN(num) || num < 1 || num > 6) {
                alert('Invalid choice.');
                return;
            }

            let targetField;
            switch (num) {
                case 1: targetField = field1; break;
                case 2: targetField = field2; break;
                case 3: targetField = field3; break;
                case 4: targetField = field4; break;
                case 5: targetField = field5; break;
                case 6: targetField = field6; break;
            }

            targetField.value = wordText;
        }
    </script>
</body>
</html>
