<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OCR Image Processor with Clickable Text Highlights and Rectangle Selection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tesseract.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 15px;
        }
        p {
            margin-bottom: 15px;
        }
        .input-section {
            margin-bottom: 20px;
        }
        .input-section label {
            display: block;
            margin: 10px 0 5px 0;
        }
        #imageInput {
            margin-bottom: 10px;
        }
        #imageContainer {
            position: relative;
            display: inline-block;
            margin-top: 10px;
            padding: 0;
        }
        #uploadedImage {
            max-width: 100%;
            border: 1px solid #ddd;
            display: block;
        }
        /* Updated overlayCanvas CSS: Removed width and height */
        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            pointer-events: auto;
            /* Removed width and height to manage via JavaScript */
        }
        #statusMessage {
            font-size: 14px;
            color: #555;
            margin-top: 10px;
        }
        #fieldContainer {
            margin-top: 20px;
        }
        #fieldContainer label {
            font-weight: bold;
            margin: 10px 0 5px 0;
        }
        #fieldContainer input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
        }
        .buttons-container button {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            margin-right: 10px;
        }
        #perform-ocr {
            background-color: #2cb67d;
            color: #fff;
        }
        #update-table {
            background-color: #3498db;
            color: #fff;
        }
        #save-csv {
            background-color: #f39c12;
            color: #fff;
        }
        #clear-image {
            background-color: #d00000;
            color: #fff;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }
        th {
            background: #f2f2f2;
            font-weight: bold;
        }
        /* Styles for rectangle drawing */
        .rectangle {
            border: 2px dashed #ff0000;
            position: absolute;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h1>OCR Image Processor with Clickable Text Highlights and Rectangle Selection</h1>
    <p>Upload an image and draw rectangles around the text areas you want to perform OCR on. Only the text within these rectangles will be processed and highlighted. Click on a highlighted block to assign its text to one of the input fields. You can edit fields manually as well. Once done, press "Update Table" to add a row to the table. Process multiple images by clearing the image and fields. Finally, press "Save CSV" to download all collected data.</p>

    <div class="input-section">
        <label for="imageInput">Upload Image:</label>
        <input type="file" id="imageInput" accept="image/*">
        <div id="imageContainer" style="display:none;">
            <img id="uploadedImage" alt="Uploaded Image">
            <canvas id="overlayCanvas"></canvas>
            <!-- Container for drawing rectangles -->
            <div id="rectContainer"></div>
        </div>
        <p id="statusMessage"></p>
        <button id="perform-ocr">Perform OCR</button>
        <button id="clear-image">Clear Image & Fields</button>
    </div>

    <div id="fieldContainer">
        <label for="field1">Item Name Short:</label>
        <input type="text" id="field1">
        <label for="field2">Item Name Long:</label>
        <input type="text" id="field2">
        <label for="field3">UPC:</label>
        <input type="text" id="field3">
        <label for="field4">Location:</label>
        <input type="text" id="field4">
        <label for="field5">Downstack:</label>
        <input type="text" id="field5">
        <label for="field6">Notes:</label>
        <input type="text" id="field6">
    </div>

    <div class="buttons-container">
        <button id="update-table">Update Table</button>
        <button id="save-csv">Save CSV</button>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
                <th>Item Name Short</th>
                <th>Item Name Long</th>
                <th>UPC</th>
                <th>Location</th>
                <th>Downstack</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be appended here -->
        </tbody>
    </table>

    <script>
        const imageInput = document.getElementById('imageInput');
        const uploadedImage = document.getElementById('uploadedImage');
        const imageContainer = document.getElementById('imageContainer');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const rectContainer = document.getElementById('rectContainer');
        const performOcrButton = document.getElementById('perform-ocr');
        const clearImageButton = document.getElementById('clear-image');
        const statusMessage = document.getElementById('statusMessage');
        const dataTable = document.getElementById('dataTable').querySelector('tbody');

        const field1 = document.getElementById('field1');
        const field2 = document.getElementById('field2');
        const field3 = document.getElementById('field3');
        const field4 = document.getElementById('field4');
        const field5 = document.getElementById('field5');
        const field6 = document.getElementById('field6');

        const updateTableButton = document.getElementById('update-table');
        const saveCsvButton = document.getElementById('save-csv');

        let currentHighlights = []; // Store highlighted blocks
        let imageDataURL = null; // For OCR

        // Rectangle drawing variables
        let isDrawing = false;
        let startX = 0;
        let startY = 0;
        let currentRect = null;

        // Scaling factors
        let scaleX = 1;
        let scaleY = 1;

        imageInput.addEventListener('change', () => {
            const file = imageInput.files[0];
            if (!file) {
                resetImageDisplay();
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage.src = e.target.result;
                uploadedImage.onload = () => {
                    imageContainer.style.display = 'inline-block';
                    
                    // Set the canvas size to match the displayed image size
                    overlayCanvas.width = uploadedImage.clientWidth;
                    overlayCanvas.height = uploadedImage.clientHeight;

                    // Set the rectContainer size
                    rectContainer.style.width = `${uploadedImage.clientWidth}px`;
                    rectContainer.style.height = `${uploadedImage.clientHeight}px`;

                    clearCanvas();
                    clearRectangles();
                    statusMessage.textContent = 'Image loaded. Draw rectangles around text areas and then click "Perform OCR".';
                    imageDataURL = e.target.result;
                };
            };
            reader.readAsDataURL(file);
        });

        performOcrButton.addEventListener('click', async () => {
            if (!imageDataURL) {
                alert('Please select an image first.');
                return;
            }
            if (currentHighlights.length === 0) {
                alert('Please draw at least one rectangle around the text areas you want to process.');
                return;
            }
            statusMessage.textContent = 'Performing OCR... please wait.';
            clearCanvas();

            // Clear previous highlights
            currentHighlights = [];

            // Perform OCR on each rectangle
            for (let rect of rectangles) {
                const { x, y, width, height } = rect;

                // Extract the region from the image
                const regionDataURL = await getImageRegion(imageDataURL, x, y, width, height);
                
                // Perform OCR on the region
                const ocrResult = await runOCR(regionDataURL);

                // Concatenate all words into a single string
                const text = ocrResult.data.text.trim().replace(/\s+/g, ' ');

                if (text) {
                    // Draw highlight
                    drawHighlight(x, y, width, height, text);
                }
            }

            statusMessage.textContent = 'OCR complete. Click on highlighted areas to assign text to fields.';
        });

        clearImageButton.addEventListener('click', () => {
            resetImageDisplay();
            resetFields();
            statusMessage.textContent = 'Cleared image and fields. Table is preserved. You can upload a new image.';
        });

        updateTableButton.addEventListener('click', () => {
            const row = document.createElement('tr');
            const cols = [field1.value.trim(), field2.value.trim(), field3.value.trim(), field4.value.trim(), field5.value.trim(), field6.value.trim()];
            if (cols.every(c => c === '')) {
                alert('All fields are empty. Nothing to add.');
                return;
            }
            cols.forEach(c => {
                const td = document.createElement('td');
                td.textContent = c;
                row.appendChild(td);
            });
            dataTable.appendChild(row);
            alert('Row added to the table.');
        });

        saveCsvButton.addEventListener('click', () => {
            const rows = dataTable.querySelectorAll('tr');
            if (rows.length === 0) {
                alert('No data to save.');
                return;
            }
            const headers = ["Item Name Short", "Item Name Long", "UPC", "Location", "Downstack", "Notes"];
            const data = [headers];

            rows.forEach(r => {
                const cells = r.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`);
                data.push(rowData);
            });

            const csvContent = data.map(r => r.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ocr_data.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Rectangle Drawing Functionality
        let rectangles = []; // Store drawn rectangles

        overlayCanvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const rect = overlayCanvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            currentRect = { x: startX, y: startY, width: 0, height: 0 };
        });

        overlayCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const rect = overlayCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            currentRect.width = mouseX - startX;
            currentRect.height = mouseY - startY;
            drawCanvas();
            drawCurrentRectangle();
        });

        overlayCanvas.addEventListener('mouseup', (e) => {
            if (!isDrawing) return;
            isDrawing = false;
            // Normalize rectangle dimensions
            const normRect = normalizeRectangle(currentRect);
            rectangles.push(normRect);
            drawCanvas();
            drawAllRectangles();
            addRectangleDiv(normRect);
            currentRect = null;
        });

        // Function to normalize rectangle dimensions
        function normalizeRectangle(rect) {
            let { x, y, width, height } = rect;
            if (width < 0) {
                x += width;
                width = Math.abs(width);
            }
            if (height < 0) {
                y += height;
                height = Math.abs(height);
            }
            return { x, y, width, height };
        }

        // Function to draw all rectangles on the canvas
        function drawAllRectangles() {
            const ctx = overlayCanvas.getContext('2d');
            ctx.strokeStyle = 'rgba(255, 0, 0, 1)';
            ctx.lineWidth = 2;
            rectangles.forEach(rect => {
                ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);
            });
        }

        // Function to draw the current rectangle being drawn
        function drawCurrentRectangle() {
            if (!currentRect) return;
            const ctx = overlayCanvas.getContext('2d');
            ctx.strokeStyle = 'rgba(0, 255, 0, 1)';
            ctx.lineWidth = 2;
            const { x, y, width, height } = currentRect;
            ctx.strokeRect(x, y, width, height);
        }

        // Function to clear the canvas
        function clearCanvas() {
            const ctx = overlayCanvas.getContext('2d');
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        }

        // Function to reset the image display and clear all data
        function resetImageDisplay() {
            uploadedImage.src = '';
            imageContainer.style.display = 'none';
            imageDataURL = null;
            clearCanvas();
            clearRectangles();
            rectangles = [];
            currentHighlights = [];
        }

        // Function to reset input fields
        function resetFields() {
            field1.value = '';
            field2.value = '';
            field3.value = '';
            field4.value = '';
            field5.value = '';
            field6.value = '';
        }

        // Function to clear all rectangle overlays
        function clearRectangles() {
            rectContainer.innerHTML = '';
            rectangles = [];
        }

        // Function to add a visual rectangle overlay (optional for better UX)
        function addRectangleDiv(rect) {
            const div = document.createElement('div');
            div.classList.add('rectangle');
            div.style.left = `${rect.x}px`;
            div.style.top = `${rect.y}px`;
            div.style.width = `${rect.width}px`;
            div.style.height = `${rect.height}px`;
            rectContainer.appendChild(div);
        }

        // Function to extract a region from the image and return as Data URL
        async function getImageRegion(dataURL, x, y, width, height) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = dataURL;
                img.onload = () => {
                    // Create a temporary canvas to extract the region
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');

                    // Set the canvas size to the region size
                    tempCanvas.width = width;
                    tempCanvas.height = height;

                    // Draw the image region onto the temporary canvas
                    tempCtx.drawImage(img, x, y, width, height, 0, 0, width, height);

                    // Get the Data URL of the region
                    const regionDataURL = tempCanvas.toDataURL();
                    resolve(regionDataURL);
                };
            });
        }

        // Function to perform OCR using Tesseract.js
        async function runOCR(dataURL) {
            const worker = await Tesseract.createWorker({
                logger: m => console.log(m) // Optional: Add logging
            });
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            const { data } = await worker.recognize(dataURL);
            await worker.terminate();
            return data;
        }

        // Function to draw highlighted blocks on the canvas
        function drawHighlight(x, y, width, height, text) {
            const ctx = overlayCanvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'rgba(0, 150, 255, 1)';
            ctx.fillStyle = 'rgba(0, 150, 255, 0.25)';
            ctx.fillRect(x, y, width, height);
            ctx.strokeRect(x, y, width, height);

            // Store the highlight with its position and text
            currentHighlights.push({
                x: x,
                y: y,
                width: width,
                height: height,
                text: text
            });
        }

        // Click handler for the overlay canvas to assign text to fields
        overlayCanvas.addEventListener('click', (e) => {
            const rect = overlayCanvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            for (let highlight of currentHighlights) {
                if (
                    clickX >= highlight.x &&
                    clickX <= highlight.x + highlight.width &&
                    clickY >= highlight.y &&
                    clickY <= highlight.y + highlight.height
                ) {
                    assignTextToField(highlight.text);
                    break;
                }
            }
        });

        // Function to assign text to a chosen input field
        function assignTextToField(text) {
            const choice = prompt(
                `Choose a field to assign this text:\n` +
                `1) Item Name Short\n` +
                `2) Item Name Long\n` +
                `3) UPC\n` +
                `4) Location\n` +
                `5) Downstack\n` +
                `6) Notes\n\n` +
                `Enter a number 1-6:`
            );
            if (!choice) return; // user canceled
            const num = parseInt(choice, 10);
            if (isNaN(num) || num < 1 || num > 6) {
                alert('Invalid choice.');
                return;
            }

            let targetField;
            switch (num) {
                case 1: targetField = field1; break;
                case 2: targetField = field2; break;
                case 3: targetField = field3; break;
                case 4: targetField = field4; break;
                case 5: targetField = field5; break;
                case 6: targetField = field6; break;
            }

            targetField.value = text;
        }
    </script>
</body>
</html>
